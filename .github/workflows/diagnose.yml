name: Diagnose Build

on:
  workflow_dispatch:

jobs:
  check-environment:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Show directory structure
      run: |
        echo "=== Repository Structure ==="
        ls -la
        echo ""
        echo "=== Compiler directory ==="
        ls -la compiler/ || echo "No compiler directory"
        echo ""
        echo "=== Runtime directory ==="
        ls -la runtime/ || echo "No runtime directory"
    
    - name: Check LLVM/MLIR availability
      run: |
        echo "=== Checking for LLVM/MLIR 19 ==="
        apt-cache search llvm-19 || echo "No LLVM 19 in apt"
        apt-cache search mlir-19 || echo "No MLIR 19 in apt"
        
        echo ""
        echo "=== Available LLVM versions ==="
        apt-cache search "^llvm-[0-9]" | grep "^llvm-"
        
        echo ""
        echo "=== Available MLIR versions ==="
        apt-cache search "^mlir-" || echo "No MLIR packages found"
    
    - name: Try installing dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake || echo "Failed to install basics"
        
        # Try LLVM 19
        sudo apt-get install -y llvm-19 llvm-19-dev || echo "LLVM 19 not available"
        
        # Try MLIR 19
        sudo apt-get install -y mlir-19-tools libmlir-19-dev || echo "MLIR 19 not available"
        
        echo ""
        echo "=== What got installed? ==="
        which llvm-config || echo "No llvm-config"
        which mlir-opt || echo "No mlir-opt"
        ls /usr/lib/llvm*/lib/cmake/ || echo "No LLVM cmake files"
