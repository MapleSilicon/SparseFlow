name: v0.7 verify (verifier + cost)

on:
  push:
    branches: [ "v0.7" ]
  pull_request:
    branches: [ "v0.7" ]
jobs:
  v07:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps (LLVM/MLIR 19)
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          sudo add-apt-repository "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-19 main"
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential \
            llvm-19 llvm-19-dev clang-19 lld-19 \
            mlir-19-tools libmlir-19-dev

      - name: Configure + build pass plugin
        run: |
          cmake -S compiler -B compiler/build -G Ninja \
            -DMLIR_DIR=/usr/lib/llvm-19/lib/cmake/mlir \
            -DLLVM_DIR=/usr/lib/llvm-19/lib/cmake/llvm
          cmake --build compiler/build -j 2

      - name: Run v0.7 verification (guardrail + cost)
        env:
          BUILD_DIR: compiler/build
          MLIR_OPT: mlir-opt-19
          MIN_REUSE_X: "32"
          GOLDEN_MLIR: compiler/tests/test_gpu_full_pipeline.mlir
          NEG_DIR: compiler/tests/negative
        run: |
          ./compiler/scripts/ci_verify_v07.sh
