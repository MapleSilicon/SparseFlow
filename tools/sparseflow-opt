#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PLUGIN="$ROOT_DIR/compiler/build/passes/SparseFlowPasses.so"

exec mlir-opt-19 -load-pass-plugin "$PLUGIN" \
  -pass-pipeline='builtin.module(func.func(
    sparseflow-annotate-nm{n=2 m=4},
    sparseflow-verify-pattern,
    sparseflow-generate-mask,
    sparseflow-sparse-compute,
    sparseflow-simple-gpu-lowering,
    sparseflow-export-metadata
  ))' \
  "$@"
